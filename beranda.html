<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Beranda</title>
    <link rel="icon" href="ikon2.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
    :root{
        --bg:#0b1020; --card:#111421; --accent:#00d4ff; --accent-2:#8b5cf6;
        --muted:#9aa3b2; --glass: rgba(255,255,255,0.08);
        --radius:18px;
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}

    html,body{
        height:100%;
        margin:0;
        overflow:hidden;
        background:linear-gradient(180deg,var(--bg),#071022);
        color:#e8eef6;
    }

    .wrap{display:flex;height:100%}

    .sidebar{
        width:260px;
        padding:28px;
        background:linear-gradient(180deg,var(--card), rgba(17,20,33,0.6));
        backdrop-filter:blur(10px);
        border-right:1px solid rgba(255,255,255,0.03);
        display:flex;
        flex-direction:column;
        gap:18px;
    }

    .logo{display:flex;gap:12px;align-items:center}
    .logo img{width:44px;height:44px;border-radius:10px;object-fit:cover}
    .logo .title{font-weight:700;font-size:1.05rem}

    .profile-card{
        background:var(--glass);
        padding:14px;
        border-radius:12px;
        display:flex;
        flex-direction:column;
        gap:4px;
        border: 1px solid rgba(255,255,255,0.1)
    }
    .p-info h3{margin:0;font-size:0.95rem}
    .p-info small{color:var(--muted)}

    .nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .nav a{
        padding:10px;
        border-radius:10px;
        text-decoration:none;
        color:var(--muted);
        display:flex;
        justify-content:space-between;
        align-items:center
    }
    .nav a:hover{
        background:linear-gradient(90deg, rgba(0,212,255,0.1), rgba(139,92,246,0.08));
        color:var(--accent)
    }

    .content{
        flex:1;
        display:flex;
        flex-direction:column;
        padding:32px;
        gap:28px;
        height:100%;
        overflow:hidden;
    }

    .top{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:12px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        padding-bottom: 15px;
    }
    .top h1 {
        margin:0;
        font-size:1.8rem;
        font-weight:800;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .grid{
        flex:1;
        display:grid;
        grid-template-columns: 2fr 1fr;
        grid-template-rows: auto 1fr;
        gap: 20px;
        overflow:hidden;
    }

    .card{
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 8px 32px 0 rgba(11, 16, 32, 0.6);
        padding: 24px;
        border-radius: var(--radius);
        min-height: 180px;
        display:flex;
        flex-direction:column;
        overflow:hidden;
    }

    #card-tugas { grid-column: 1 / 2; grid-row: 1 / 3; }
    #card-motivasi { grid-column: 2 / 3; }
    #card-pesan { grid-column: 2 / 3; }

    .card h4{
        margin:0 0 15px 0;
        color:var(--accent-2);
        font-size:1.1rem;
        border-bottom: 2px solid rgba(139,92,246,0.2);
        padding-bottom: 8px;
    }

    .task{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.08);}
    .task:last-child {border-bottom: none;}
    .task .title{font-weight:600;}
    .task small{color:var(--muted); font-size:0.85rem;}

    .btn{
        padding:8px 12px;
        border-radius:10px;
        border:none;
        cursor:pointer;
        background:linear-gradient(90deg,var(--accent),var(--accent-2));
        color:#041021;
        font-weight:700
    }

    #quote { font-style: italic; font-size: 1.15rem; color: var(--accent); line-height: 1.6; }

    .message-item { margin-bottom: 12px; padding-left: 10px; border-left: 3px solid var(--accent); }
    .message-item strong { display: block; font-size: 0.95rem; }
    .message-item .text { color: var(--muted); font-size: 0.85rem; }

    #list-pesan {
        flex:1;
        overflow-y:auto;
        padding-right: 6px;
    }
    #list-pesan::-webkit-scrollbar { width: 6px; }
    #list-pesan::-webkit-scrollbar-thumb { background: var(--accent-2); border-radius: 4px; }
    #list-pesan::-webkit-scrollbar-track { background: transparent; }

    #list-tugas {
        flex:1;
        overflow-y:auto;
        padding-right: 6px;
    }
    #list-tugas::-webkit-scrollbar { width: 6px; }
    #list-tugas::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }
    #list-tugas::-webkit-scrollbar-track { background: transparent; }

    @media (max-width:920px){
        .grid{ grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
        #card-tugas, #card-motivasi, #card-pesan { grid-column: 1 / 2; grid-row: auto; }
    }
    @media (max-width:640px){
        .wrap{flex-direction:column}
        .sidebar{width:100%;flex-direction:row;overflow-x:auto;padding:12px}
        .content{padding:14px}
    }
</style>
</head>
<body>
    <div class="wrap">
        <aside class="sidebar">
            <div class="logo">
                <img id="ikon-user" src="profil2.png" alt="ikon">
                <div>
                    <div class="title">MyDashboard</div>
                    <small style="color:var(--muted)">Selamat datang</small>
                </div>
            </div>
            <div class="profile-card">
                <div class="p-info">
                    <h3 id="nama-user">--</h3>
                    <small id="email-user">--</small>
                </div>
            </div>
            <nav class="nav">
                <a href="beranda.html" class="active">Beranda <small>â€º</small></a>
                <a href="profil.html">Profil <small>â€º</small></a>
                <a href="tugas.html">Tugas <small>â€º</small></a>
                <a href="chat.html">Pesan <small>â€º</small></a>
                <a href="kuis.html">Menejemen Kuis<small>â€º</small></a>
            </nav>
            <div style="margin-top:auto;color:var(--muted);font-size:0.85rem">
                Versi alpha â€¢ &copy; 2025
            </div>
        </aside>

        <main class="content">
            <div class="top">
                <h1>Selamat Datang, <span id="welcome-name">...</span>!</h1>
                <div style="margin-left:auto; display:flex; align-items:center; gap:15px;">
                    <div style="color:var(--muted)">Hari ini: <span id="hari-nama">-</span>, <span id="tanggal">-</span></div>
                    <button id="btn-logout" class="btn" style="padding:6px 12px;">Keluar</button>
                </div>
            </div>
            <div class="grid">
                <section class="card" id="card-tugas">
                    <h4>Daftar Tugas</h4>
                    <div id="list-tugas">Memuat...</div>
                </section>

                <section class="card" id="card-motivasi">
                    <h4>Motivasi Hari Ini</h4>
                    <div id="quote">Memuat motivasi...</div>
                </section>
                
                <section class="card" id="card-pesan">
                    <h4>Pesan Terbaru</h4>
                    <div id="list-pesan">Memuat pesan...</div>
                </section>
            </div>
        </main>
    </div>

<script>
const userId = sessionStorage.getItem("currentUser");
if (!userId) {
  alert("Silakan login terlebih dahulu.");
  window.location.href = "index.html";
}

const supabase = window.supabase.createClient(
  "https://hnsvxbohvjjfikmdjfpn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhuc3Z4Ym9odmpqZmlrbWRqZnBuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0Nzk0NDMsImV4cCI6MjA2ODA1NTQ0M30.KzOeS0md4A6jeexgXxSdfuXuBbG5L1WtFginkztaPFw"
);

async function loadProfile() {
  const { data, error } = await supabase
    .from("accounts")
    .select("fullname,email,photo")
    .eq("id", userId)
    .maybeSingle();

  if (error) { console.error(error); return; }
  if (data) {
    const firstName = data.fullname ? data.fullname.split(' ')[0] : 'Pengguna';
    document.getElementById("welcome-name").textContent = firstName;
    document.getElementById("nama-user").textContent = data.fullname || "--";
    document.getElementById("email-user").textContent = data.email || "--";
    if (data.photo) {
      document.getElementById("ikon-user").src = data.photo;
    }
  }
}

async function loadTugas() {
  const now = new Date();
  const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString(); 
  const endOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0, -1).toISOString(); 

  const { data, error } = await supabase
    .from("tugas")
    .select("*")
    .eq("user_id", userId)
    .eq("is_done", false)
    .lte("tanggal_awal", endOfToday)
    .gte("tanggal_akhir", startOfToday)
    .order("tanggal_akhir", { ascending: true });

  const el = document.getElementById("list-tugas");
  if (error) { 
    el.innerHTML = "<p style='color:red;'>Gagal memuat tugas.</p>"; 
    console.error(error);
    return; 
  }

  if (!data || !data.length) { 
    el.innerHTML = "<p style='color:var(--muted);'>Tidak ada tugas yang aktif hari ini ðŸŽ‰</p>";
    return;
  }

  el.innerHTML = data.map(t => {
    const deadlineStr = new Date(t.tanggal_akhir)
      .toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
    return `
      <div class="task">
        <div>
          <div class="title">${t.judul}</div>
          <small>Deadline: ${deadlineStr}</small>
        </div>
        <button class="btn btn-selesai" data-id="${t.id}" style="padding:4px 8px; font-size:0.8rem">Selesai</button>
      </div>
    `;
  }).join('');

  document.querySelectorAll('.btn-selesai').forEach(button => {
    button.addEventListener('click', (e) => {
      const taskId = e.target.getAttribute('data-id');
      if (taskId) markAsDoneAndReload(taskId);
    });
  });
}

async function markAsDoneAndReload(taskId) {
  const { error } = await supabase
    .from("tugas")
    .update({ is_done: true })
    .eq("id", taskId)
    .eq("user_id", userId);

  if (error) {
    console.error("Gagal menyelesaikan tugas:", error);
    alert("Gagal menyelesaikan tugas. Pastikan RLS di Supabase mengizinkan UPDATE oleh pemilik tugas.");
  } else {
    loadTugas(); 
  }
}

function loadMotivasi() {
  const quotes = [
    "Satu-satunya cara untuk melakukan pekerjaan hebat adalah mencintai apa yang Anda lakukan.",
    "Kesuksesan bukanlah kunci kebahagiaan. Kebahagiaan adalah kunci kesuksesan.",
    "Jangan pernah menyerah pada mimpi. Hidup adalah tentang jatuh tujuh kali dan bangkit delapan kali.",
    "Masa depan adalah milik mereka yang percaya pada keindahan mimpi-mimpi mereka.",
    "Proses belajar adalah penemuan tak terbatas yang akan membawa Anda ke puncak."
  ];
  const quoteEl = document.getElementById("quote");
  const randomIndex = Math.floor(Math.random() * quotes.length);
  quoteEl.textContent = quotes[randomIndex];
}

document.getElementById('btn-logout').addEventListener('click', () => {
  sessionStorage.removeItem("currentUser");
  alert("Anda telah keluar.");
  window.location.href = "index.html";
});

async function loadPesanRealtime() {
  const el = document.getElementById("list-pesan");

  function renderPesan(pesanList) {
    if (!pesanList.length) {
      el.innerHTML = "<p style='color:var(--muted);'>Belum ada pesan terbaru.</p>";
      return;
    }
    el.innerHTML = pesanList.map(p => `
      <div class="message-item">
        <strong>${p.sender_name || "Anonim"}</strong>
        <div class="text">${p.text.length > 50 ? p.text.substring(0,50)+'...' : p.text}</div>
      </div>
    `).join('') + `
      <a href="chat.html" class="btn" style="display:block; text-align:center; margin-top:15px; background:var(--glass); color:var(--accent);">Buka Chat</a>
    `;

    el.scrollTop = el.scrollHeight;
  }

  async function fetchLatestPesan() {
    const { data, error } = await supabase
      .from("messages")
      .select("text, sender:accounts!messages_sender_fkey(fullname)")
      .order("created_at", { descending: true })
      .limit(20);

    if (error) {
      console.error("Gagal memuat pesan:", error);
      return [];
    }

    return Array.isArray(data) ? data.map(p => ({
      text: p.text,
      sender_name: p.sender?.fullname || "Anonim"
    })) : [];
  }

  let pesanList = await fetchLatestPesan();
  renderPesan(pesanList);

  supabase.channel('realtime-messages')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, async () => {
      const pesanList = await fetchLatestPesan();
      renderPesan(pesanList);
    })
    .subscribe();
}

const sekarang = new Date();
document.getElementById('hari-nama').textContent = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'][sekarang.getDay()];
document.getElementById('tanggal').textContent = sekarang.toLocaleDateString('id-ID');

loadProfile();
loadTugas();
loadMotivasi();
loadPesanRealtime();
</script>
</body>
</html>
