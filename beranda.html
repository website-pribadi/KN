<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beranda</title>
  <link rel="icon" href="ikon2.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
  :root{
    --bg:#0b1020; --card:#111421; --accent:#00d4ff; --accent-2:#8b5cf6;
    --muted:#9aa3b2; --glass: rgba(255,255,255,0.08);
    --radius:18px;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}

  html,body{
    height:100%;
    margin:0;
    overflow:auto;
    background:linear-gradient(180deg,var(--bg),#071022);
    color:#e8eef6;
  }

  .wrap{display:flex;min-height:100%}

  /* Sidebar */
  .sidebar{
    width:260px;
    padding:28px;
    background:linear-gradient(180deg,var(--card), rgba(17,20,33,0.6));
    backdrop-filter:blur(10px);
    border-right:1px solid rgba(255,255,255,0.03);
    display:flex;
    flex-direction:column;
    gap:18px;
  }
  .logo{display:flex;gap:12px;align-items:center}
  .logo img{width:44px;height:44px;border-radius:10px;object-fit:cover}
  .logo .title{font-weight:700;font-size:1.05rem}
  .profile-card{background:var(--glass);padding:14px;border-radius:12px;display:flex;flex-direction:column;gap:4px;border:1px solid rgba(255,255,255,0.1)}
  .p-info h3{margin:0;font-size:0.95rem}
  .p-info small{color:var(--muted)}
  .nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
  .nav a{padding:10px;border-radius:10px;text-decoration:none;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
  .nav a:hover{background:linear-gradient(90deg, rgba(0,212,255,0.1), rgba(139,92,246,0.08));color:var(--accent)}

  /* Konten */
  .content{
    flex:1;
    display:flex;
    flex-direction:column;
    padding:32px;
    gap:28px;
    padding-bottom:90px;
  }
  .top{display:flex;justify-content:space-between;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:15px}
  .top h1{margin:0;font-size:1.8rem;font-weight:800;background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}

  .grid{flex:1;display:grid;grid-template-columns: 2fr 1fr;grid-template-rows:auto 1fr;gap:20px}
  .card{background:rgba(255,255,255,0.05);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.15);box-shadow:0 8px 32px rgba(11,16,32,0.6);padding:24px;border-radius:var(--radius);min-height:180px;display:flex;flex-direction:column}
  #card-tugas { grid-column:1/2;grid-row:1/3 }
  #card-motivasi { grid-column:2/3 }
  #card-pesan { grid-column:2/3 }
  .card h4{margin:0 0 15px;color:var(--accent-2);font-size:1.1rem;border-bottom:2px solid rgba(139,92,246,0.2);padding-bottom:8px}

  /* Daftar tugas */
  #list-tugas {
    flex:1;
    overflow-y:auto;
    max-height:400px;
    padding-right:4px;
  }
  #list-tugas::-webkit-scrollbar {
    width:6px;
  }
  #list-tugas::-webkit-scrollbar-thumb {
    background:rgba(255,255,255,0.2);
    border-radius:10px;
  }
  .task {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px 0;
    border-bottom:1px solid rgba(255,255,255,0.08);
  }
  .task:last-child { border-bottom:none; }
  .task .title{font-weight:600;}
  .task small{color:var(--muted); font-size:0.85rem;}

  /* Pesan Terbaru */
  #list-pesan {
    flex:1;
    overflow-y:auto;
    max-height:200px;
    padding-right:4px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  #list-pesan::-webkit-scrollbar {
    width:6px;
  }
  #list-pesan::-webkit-scrollbar-thumb {
    background:rgba(255,255,255,0.2);
    border-radius:10px;
  }
  .message-item {
    background: rgba(255,255,255,0.04);
    border-left: 3px solid var(--accent-2);
    padding: 10px 12px;
    border-radius: 10px;
  }
  .message-item strong {
    display: block;
    font-weight: 600;
    font-size: 0.95rem;
    color: #fff;
  }
  .message-item .text {
    color: var(--muted);
    font-size: 0.85rem;
    margin-top: 3px;
  }
  .open-chat-btn {
    display: block;
    text-align: center;
    padding: 8px 0;
    background: rgba(255,255,255,0.06);
    border-radius: 8px;
    margin-top: 10px;
    text-decoration: none;
    color: var(--accent);
    font-weight: 600;
    transition: background 0.2s;
  }
  .open-chat-btn:hover {
    background: rgba(255,255,255,0.1);
  }

  /* Tombol */
  .btn {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 12px;
    border:none;
    border-radius:10px;
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    color:#041021;
    font-weight:600;
    cursor:pointer;
    white-space:nowrap;
  }
  .btn:active { transform:scale(0.96); }
  .btn-small { padding:4px 10px;font-size:0.8rem; }

  /* Bottom nav */
  .bottom-nav {
    position: fixed;
    bottom:0;left:0;right:0;
    height:62px;
    background:rgba(17,20,33,0.9);
    border-top:1px solid rgba(255,255,255,0.05);
    display:none;
    justify-content:space-around;
    align-items:center;
    z-index:1000;
    backdrop-filter:blur(10px);
    padding-bottom:env(safe-area-inset-bottom);
  }
  .bottom-nav a{flex:1;text-align:center;text-decoration:none;color:#e8eef6;font-size:12px;display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 4px;border-radius:10px}
  .bottom-nav a .ico{font-size:18px}
  .bottom-nav a.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#041021;font-weight:700}
  
  /* Responsive */
  @media(max-width:920px){
    .grid{grid-template-columns:1fr;grid-template-rows:auto 1fr}
    #card-tugas,#card-motivasi,#card-pesan{grid-column:1/2;grid-row:auto}
  }
  @media(max-width:640px){
    .wrap{flex-direction:column}
    .sidebar{display:none}
    .content{padding:16px;padding-bottom:90px}
    .bottom-nav{display:flex}
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <img id="ikon-user" src="profil2.png" alt="ikon">
        <div>
          <div class="title">MyDashboard</div>
          <small style="color:var(--muted)">Selamat datang</small>
        </div>
      </div>
      <div class="profile-card">
        <div class="p-info">
          <h3 id="nama-user">--</h3>
          <small id="email-user">--</small>
        </div>
      </div>
      <nav class="nav">
        <a href="beranda.html" class="active">Beranda <small>‚Ä∫</small></a>
        <a href="profil.html">Profil <small>‚Ä∫</small></a>
        <a href="tugas.html">Tugas <small>‚Ä∫</small></a>
        <a href="chat.html">Pesan <small>‚Ä∫</small></a>
        <a href="kuis.html">Manajemen Kuis <small>‚Ä∫</small></a>
      </nav>
    </aside>

    <!-- Konten -->
    <main class="content">
      <div class="top">
        <h1>Selamat Datang, <span id="welcome-name">...</span>!</h1>
        <div style="margin-left:auto;display:flex;align-items:center;gap:15px;">
          <div style="color:var(--muted)">Hari ini: <span id="hari-nama">-</span>, <span id="tanggal">-</span></div>
          <button id="btn-logout" class="btn" style="padding:6px 12px;">Keluar</button>
        </div>
      </div>
      <div class="grid">
        <section class="card" id="card-tugas">
          <h4>Daftar Tugas</h4>
          <div id="list-tugas">Memuat...</div>
        </section>
        <section class="card" id="card-motivasi">
          <h4>Motivasi Hari Ini</h4>
          <div id="quote">Memuat motivasi...</div>
        </section>
        <section class="card" id="card-pesan">
          <h4>Pesan Terbaru</h4>
          <div id="list-pesan">Memuat pesan...</div>
        </section>
      </div>
    </main>
  </div>

  <!-- Bottom nav -->
  <nav class="bottom-nav">
    <a href="beranda.html" id="nav-home"><span class="ico">üè†</span><span>Beranda</span></a>
    <a href="profil.html" id="nav-profil"><span class="ico">üë§</span><span>Profil</span></a>
    <a href="tugas.html" id="nav-tugas"><span class="ico">üìù</span><span>Tugas</span></a>
    <a href="chat.html" id="nav-chat"><span class="ico">üí¨</span><span>Chat</span></a>
    <a href="kuis.html" id="nav-kuis"><span class="ico">‚ùì</span><span>Kuis</span></a>
  </nav>

<script>
const userId = sessionStorage.getItem("currentUser");
if (!userId) {
  alert("Silakan login terlebih dahulu.");
  window.location.href = "index.html";
}

const supabase = window.supabase.createClient(
  "https://hnsvxbohvjjfikmdjfpn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhuc3Z4Ym9odmpqZmlrbWRqZnBuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0Nzk0NDMsImV4cCI6MjA2ODA1NTQ0M30.KzOeS0md4A6jeexgXxSdfuXuBbG5L1WtFginkztaPFw"
);

async function loadProfile() {
  const { data, error } = await supabase
    .from("accounts")
    .select("fullname,email,photo")
    .eq("id", userId)
    .maybeSingle();

  if (error) return console.error(error);
  if (data) {
    const firstName = data.fullname ? data.fullname.split(' ')[0] : 'Pengguna';
    document.getElementById("welcome-name").textContent = firstName;
    document.getElementById("nama-user").textContent = data.fullname || "--";
    document.getElementById("email-user").textContent = data.email || "--";
    if (data.photo) document.getElementById("ikon-user").src = data.photo;
  }
}

async function loadTugas() {
  const now = new Date();
  const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString(); 
  const endOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0, -1).toISOString(); 

  const { data, error } = await supabase
    .from("tugas")
    .select("*")
    .eq("user_id", userId)
    .eq("is_done", false)
    .lte("tanggal_awal", endOfToday)
    .gte("tanggal_akhir", startOfToday)
    .order("tanggal_akhir", { ascending: true });

  const el = document.getElementById("list-tugas");
  if (error) { 
    el.innerHTML = "<p style='color:red;'>Gagal memuat tugas.</p>"; 
    console.error(error);
    return; 
  }

  if (!data || !data.length) { 
    el.innerHTML = "<p style='color:var(--muted);'>Tidak ada tugas yang aktif hari ini üéâ</p>";
    return;
  }

  el.innerHTML = data.map(t => {
    const deadlineStr = new Date(t.tanggal_akhir)
      .toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
    return `
      <div class="task">
        <div>
          <div class="title">${t.judul}</div>
          <small>Deadline: ${deadlineStr}</small>
        </div>
        <button class="btn btn-selesai" data-id="${t.id}" style="padding:4px 8px; font-size:0.8rem">Selesai</button>
      </div>
    `;
  }).join('');

  document.querySelectorAll('.btn-selesai').forEach(button => {
    button.addEventListener('click', (e) => {
      const taskId = e.target.getAttribute('data-id');
      if (taskId) markAsDoneAndReload(taskId);
    });
  });
}

async function markAsDoneAndReload(taskId) {
  const { error } = await supabase
    .from("tugas")
    .update({ is_done: true })
    .eq("id", taskId)
    .eq("user_id", userId);

  if (error) {
    console.error("Gagal menyelesaikan tugas:", error);
    alert("Gagal menyelesaikan tugas. Pastikan RLS di Supabase mengizinkan UPDATE oleh pemilik tugas.");
  } else {
    loadTugas(); 
  }
}

function loadMotivasi() {
  const quotes = [
    "Satu-satunya cara untuk melakukan pekerjaan hebat adalah mencintai apa yang Anda lakukan.",
    "Kesuksesan bukanlah kunci kebahagiaan. Kebahagiaan adalah kunci kesuksesan.",
    "Jangan pernah menyerah pada mimpi. Hidup adalah tentang jatuh tujuh kali dan bangkit delapan kali.",
    "Masa depan adalah milik mereka yang percaya pada keindahan mimpi-mimpi mereka.",
    "Proses belajar adalah penemuan tak terbatas yang akan membawa Anda ke puncak."
  ];
  const quoteEl = document.getElementById("quote");
  const randomIndex = Math.floor(Math.random() * quotes.length);
  quoteEl.textContent = quotes[randomIndex];
}

document.getElementById('btn-logout').addEventListener('click', () => {
  sessionStorage.removeItem("currentUser");
  alert("Anda telah keluar.");
  window.location.href = "index.html";
});

async function loadPesanRealtime() {
  const el = document.getElementById("list-pesan");

  function renderPesan(pesanList) {
    if (!pesanList.length) {
      el.innerHTML = "<p style='color:var(--muted);'>Belum ada pesan terbaru.</p>";
      return;
    }
    const latest = pesanList.slice(0, 20);
    el.innerHTML = latest.map(p => `
      <div class="message-item">
        <strong>${p.sender_name || "Anonim"}</strong>
        <div class="text">${p.text.length > 50 ? p.text.substring(0,50)+'...' : p.text}</div>
      </div>
    `).join('') + `
      <a href="chat.html" class="open-chat-btn">Buka Chat</a>
    `;
  }

  async function fetchLatestPesan() {
    const { data, error } = await supabase
      .from("messages")
      .select("text, sender:accounts!messages_sender_fkey(fullname)")
      .order("created_at", { descending: true })
      .limit(20);

    if (error) {
      console.error("Gagal memuat pesan:", error);
      return [];
    }

    return Array.isArray(data) ? data.map(p => ({
      text: p.text,
      sender_name: p.sender?.fullname || "Anonim"
    })) : [];
  }

  let pesanList = await fetchLatestPesan();
  renderPesan(pesanList);

  supabase.channel('realtime-messages')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, async () => {
      const pesanList = await fetchLatestPesan();
      renderPesan(pesanList);
    })
    .subscribe();
}

const sekarang = new Date();
document.getElementById('hari-nama').textContent = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'][sekarang.getDay()];
document.getElementById('tanggal').textContent = sekarang.toLocaleDateString('id-ID');

loadProfile();
loadTugas();
loadMotivasi();
loadPesanRealtime();
</script>
</body>
</html>
