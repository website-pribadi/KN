<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Private</title>
  <link rel="icon" href="ikon2.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #d2dbdc;
      display: flex; justify-content: center; align-items: center;
    }
    .chat-box { width: 100vw; height: 100vh; background: #f8f9fa; display: flex; flex-direction: column; }
    .header {
      background: #075e54; color: white;
      padding: 14px; font-size: 18px; font-weight: bold; text-align: center;
      position: relative;
    }
    #profilePic {
      position: absolute;
      top: 50%;
      right: 16px;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid white;
    }
    .messages {
      flex: 1; padding: 20px; overflow-y: auto; background: #efeae2;
      display: flex; flex-direction: column;
      position: relative;
    }
    .message {
      background: #fff;
      border-radius: 8px;
      padding: 8px 12px;
      margin: 6px 0;
      display: inline-block;
      font-size: 14px;
      line-height: 1.4;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 70%;
      position: relative;
    }
    .me { align-self: flex-end; background: #dcf8c6; }
    .friend { align-self: flex-start; background: #ffffff; }
    .message small { display: block; margin-top: 6px; font-size: 12px; color: #666; text-align: left; }
    .me small { text-align: right; }
    .selected { transform: translateX(-40px); box-shadow: 0 0 6px rgba(0,0,0,0.2); }
    .input-box { display: flex; align-items: center; padding: 10px; background: #f0f0f0; border-top: 1px solid #ccc; }
    .input-box input[type="text"] { flex: 1; padding: 12px; border-radius: 20px; border: none; outline: none; }
    .input-box button { margin-left: 10px; padding: 10px 20px; border: none; border-radius: 20px; background: #075e54; color: white; cursor: pointer; }
    .input-box label { margin-left: 10px; font-size: 20px; cursor: pointer; }
    #replyBox { display:none; padding:10px; background:#e0f7fa; border-left:4px solid #00796b; font-size: 13px; }
    #replyBox button { float:right; background:none; border:none; color:#00796b; cursor:pointer; }
    .context-menu {
      position: absolute;
      display: none;
      flex-direction: column;
      justify-content: space-between;
      z-index: 1000;
    }
    .context-menu button {
      width: 42px; height: 42px; font-size: 18px; background: white; border: 1px solid #ccc;
      cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15); transition: background 0.2s; padding: 0;
    }
    .context-menu button:hover { background: #f0f0f0; }

    /* üí† Gaya untuk link file */
    .file-link {
      display: inline-block;
      background: #e9f5f0;
      padding: 6px 10px;
      border-radius: 8px;
      margin-top: 6px;
      color: #075e54;
      text-decoration: none;
      font-size: 14px;
    }
    .file-link:hover { background: #d8eee6; }
  </style>
</head>
<body>
  <div class="chat-box">
    <div class="header">
      Chat Private
      <img id="profilePic" src="https://via.placeholder.com/32" alt="Profil" title="Profil" />
    </div>

    <div id="messages" class="messages"></div>

    <div id="replyBox">Membalas: <span id="replyText"></span>
      <button onclick="cancelReply()">‚úï</button>
    </div>

    <div class="input-box">
      <input id="messageInput" type="text" placeholder="Ketik pesan..." />
      <label for="fileInput">üìé</label>
      <input type="file" id="fileInput" style="display:none;" />
      <button onclick="sendMessage()">‚û§</button>
    </div>
  </div>

  <div id="contextMenu" class="context-menu">
    <button title="Balas" onclick="handleReply()">‚û•</button>
    <button title="Edit" onclick="handleEdit()">‚úé</button>
    <button title="Hapus" onclick="handleDelete()">‚å¶</button>
  </div>

  <script>
const supabase = window.supabase.createClient(
  "https://bwfoeapwqdrinqgccxpw.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3Zm9lYXB3cWRyaW5xZ2NjeHB3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MTUzNTYsImV4cCI6MjA3NTM5MTM1Nn0.grJkA6XjIvAOWzmWTMx-Rp8BUVdvwTd_pawNQsM0Vt8"
);

let userId = sessionStorage.getItem("currentUser");
if(!userId){ alert("Silakan login dulu!"); window.location.href="index.html"; }

const messagesDiv = document.getElementById("messages");
const input = document.getElementById("messageInput");
const menu = document.getElementById("contextMenu");
let replyToId = null;
let selectedMessageId = null;
let selectedMessageText = null;

async function loadProfile() {
  const { data, error } = await supabase.from("accounts")
    .select("fullname,photo")
    .eq("id", userId)
    .single();
  if (!error && data) {
    const profile = document.getElementById("profilePic");
    profile.src = data.photo || "https://via.placeholder.com/32";
    profile.title = data.fullname || "Anonim";
    profile.addEventListener("click", () => {
      location.href = "beranda.html";
    });
  }
}
loadProfile();

async function uploadFile(file) {
  if (!file) return null;
  const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, "_");
  const filePath = `${Date.now()}-${safeName}`;
  const { error } = await supabase.storage.from("chat-files").upload(filePath, file);
  if (error) {
    console.error("Upload gagal:", error);
    alert("Upload gagal: " + error.message);
    return null;
  }
  const { data } = supabase.storage.from("chat-files").getPublicUrl(filePath);
  return data.publicUrl;
}

async function sendMessage() {
  const text = input.value.trim();
  const file = document.getElementById("fileInput").files[0];
  let fileUrl = null;
  if (!text && !file) return;

  if (file) {
    fileUrl = await uploadFile(file);
    document.getElementById("fileInput").value = "";
  }

  await supabase.from("messages").insert([{
    text,
    sender: userId,
    created_at: new Date().toISOString(),
    reply_to: replyToId,
    file_url: fileUrl
  }]);

  input.value = "";
  cancelReply();
}

async function loadMessages() {
  const { data, error } = await supabase.from("messages")
    .select(`id,text,created_at,sender,reply_to,file_url,accounts:sender(fullname,photo)`)
    .order("created_at", { ascending: true });
  if (error) return;
  messagesDiv.innerHTML = "";
  data.forEach(addMessageToUI);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function addMessageToUI(msg) {
  if (document.getElementById("msg-" + msg.id)) return;
  const div = document.createElement("div");
  const isMe = msg.sender === userId;
  div.className = "message " + (isMe ? "me" : "friend");
  div.id = "msg-" + msg.id;
  const name = msg.accounts?.fullname || "Anonim";
  const photo = msg.accounts?.photo || "https://via.placeholder.com/30";
  const time = new Date(msg.created_at).toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });

  let replyHTML = "";
  if (msg.reply_to) {
    const replied = document.getElementById("msg-" + msg.reply_to);
    const repliedTextEl = replied ? replied.querySelector(".msg-text") : null;
    const repliedText = repliedTextEl ? repliedTextEl.textContent.slice(0, 30) + '...' : "Pesan Dibalas...";
    replyHTML = `<div style="background:#f0f0f0;padding:6px;border-left:3px solid #ccc;font-size:12px;margin-bottom:4px;">Membalas: ${repliedText}</div>`;
  }

  let fileHTML = "";
  if (msg.file_url) {
    const fileName = msg.file_url.split('/').pop();
    const ext = fileName.split('.').pop().toLowerCase();

    // Pilih ikon berdasarkan ekstensi file
    let icon = "üìé";
    if (["jpg","jpeg","png","gif","webp","svg"].includes(ext)) icon = "üñºÔ∏è";
    else if (["pdf"].includes(ext)) icon = "üìï";
    else if (["doc","docx"].includes(ext)) icon = "üìù";
    else if (["xls","xlsx","csv"].includes(ext)) icon = "üìä";
    else if (["ppt","pptx"].includes(ext)) icon = "üìà";
    else if (["zip","rar","7z"].includes(ext)) icon = "üóúÔ∏è";
    else if (["mp3","wav","ogg"].includes(ext)) icon = "üéµ";
    else if (["mp4","mov","avi","mkv"].includes(ext)) icon = "üé¨";
    else if (["txt","log"].includes(ext)) icon = "üìÑ";
    else if (["json","js","html","css","py"].includes(ext)) icon = "üíª";

    fileHTML = `<a href="${msg.file_url}" target="_blank" class="file-link">${icon} ${fileName}</a>`;
  }

  div.innerHTML = isMe ? `
    <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;justify-content:flex-end;">
      <strong style="font-size:12px;">${name}</strong>
      <img src="${photo}" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">
    </div>
    ${replyHTML}<span class="msg-text">${msg.text || ""}</span>${fileHTML}
    <small>${time}</small>
  ` : `
    <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;justify-content:flex-start;">
      <img src="${photo}" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">
      <strong style="font-size:12px;">${name}</strong>
    </div>
    ${replyHTML}<span class="msg-text">${msg.text || ""}</span>${fileHTML}
    <small>${time}</small>
  `;

  div.addEventListener("contextmenu", e => {
    e.preventDefault();
    selectedMessageId = msg.id;
    selectedMessageText = msg.text;
    document.querySelectorAll(".message").forEach(el => el.classList.remove("selected"));
    div.classList.add("selected");
    if (isMe) showContextMenuForMessage(div);
    else handleReply();
  });

  messagesDiv.appendChild(div);
}

function showContextMenuForMessage(messageElement) {
  const rect = messageElement.getBoundingClientRect();
  const containerRect = messagesDiv.getBoundingClientRect();
  menu.style.display = "flex";
  menu.style.height = rect.height + "px";
  const left = rect.right - containerRect.left + 6;
  const top = rect.top - containerRect.top + messagesDiv.scrollTop;
  menu.style.left = `${left}px`;
  menu.style.top = `${top}px`;
  messagesDiv.appendChild(menu);
}

function hideContextMenu() {
  menu.style.display = "none";
  menu.style.height = "auto";
  document.querySelectorAll(".message").forEach(el => el.classList.remove("selected"));
}
document.addEventListener("click", hideContextMenu);

function handleReply() {
  document.getElementById("replyText").textContent = selectedMessageText.length > 40 ? selectedMessageText.substring(0, 40) + '...' : selectedMessageText;
  document.getElementById("replyBox").style.display = "block";
  replyToId = selectedMessageId;
  hideContextMenu();
}
function cancelReply() { document.getElementById("replyBox").style.display = "none"; replyToId = null; }

async function handleEdit() {
  const newText = prompt("Edit pesan:", selectedMessageText);
  if (!newText || newText.trim() === selectedMessageText) return;
  await supabase.from("messages").update({ text: newText }).eq("id", selectedMessageId).eq("sender", userId);
  hideContextMenu();
}

async function handleDelete() {
  if (confirm("Hapus pesan?")) {
    await supabase.from("messages").delete().eq("id", selectedMessageId).eq("sender", userId);
  }
  hideContextMenu();
}

supabase.channel("room")
  .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, async payload => {
    const { data } = await supabase
      .from("messages")
      .select(`id,text,created_at,sender,reply_to,file_url,accounts:sender(fullname,photo)`)
      .eq("id", payload.new.id)
      .single();
    if (data) {
      addMessageToUI(data);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  })
  .on("postgres_changes", { event: "UPDATE", schema: "public", table: "messages" }, payload => {
    const el = document.getElementById("msg-" + payload.new.id);
    if (el) el.querySelector(".msg-text").textContent = payload.new.text;
  })
  .on("postgres_changes", { event: "DELETE", schema: "public", table: "messages" }, payload => {
    const el = document.getElementById("msg-" + payload.old.id);
    if (el) el.remove();
  })
  .subscribe();

loadMessages();
input.addEventListener("keydown", e => { if (e.key === "Enter") { e.preventDefault(); sendMessage(); } });
  </script>
</body>
</html>

