<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Profil Pengguna</title>
    <link rel="icon" href="ikon2.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root{
            --bg:#0b1020; --card:#111421; --accent:#00d4ff; --accent-2:#8b5cf6;
            --muted:#9aa3b2; --glass: rgba(255,255,255,0.04); --radius:14px;
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#071022);color:#e8eef6}
        .wrap{display:flex;min-height:100vh}
        .sidebar{
            width:260px;padding:28px;background:linear-gradient(180deg,var(--card), rgba(17,20,33,0.6));backdrop-filter:blur(6px);
            border-right:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:18px
        }
        .logo{display:flex;gap:12px;align-items:center}
        .logo img{width:44px;height:44px;border-radius:10px;object-fit:cover}
        .logo .title{font-weight:700;font-size:1.05rem}
        .profile-card{background:var(--glass);padding:14px;border-radius:12px;display:flex;flex-direction:column;gap:4px}
        .p-info h3{margin:0;font-size:0.95rem}
        .p-info small{color:var(--muted)}
        .nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
        .nav a{padding:10px;border-radius:10px;text-decoration:none;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
        .nav a:hover{background:linear-gradient(90deg, rgba(0,212,255,0.06), rgba(139,92,246,0.04));color:var(--accent)}
        .nav a.active{background:linear-gradient(90deg, rgba(0,212,255,0.1), rgba(139,92,246,0.08));color:var(--accent)}

        .content{flex:1;padding:28px;display:flex;flex-direction:column;gap:22px}
        .top{display:flex;justify-content:space-between;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:15px}
        .grid{display:grid;grid-template-columns:1fr;gap:18px;max-width:600px}

        /* Styling Form Profil */
        .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:20px;border-radius:var(--radius);box-shadow:0 6px 30px rgba(11,16,32,0.5);}
        .card h2{margin-top:0;font-size:1.4rem;color:var(--accent-2)}
        .form-group{margin-bottom:15px}
        .form-group label{display:block;margin-bottom:8px;color:var(--muted);font-size:0.9rem}
        
        .form-group input:disabled, .form-group select:disabled, .form-group textarea:disabled {
            background: #222533; 
            color: var(--muted);
            cursor: not-allowed;
            border: 1px solid rgba(255,255,255,0.04);
        }

        .form-group input:not(:disabled), .form-group select:not(:disabled), .form-group textarea:not(:disabled),
        .form-group input[type="text"], .form-group input[type="file"], 
        .form-group input[type="date"], .form-group input[type="tel"],
        .form-group select, .form-group textarea {
            width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);
            background:rgba(0,0,0,0.2);color:inherit;font-size:1rem;transition:border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {border-color:var(--accent);outline:none}
        
        .btn{padding:10px 16px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#041021;font-weight:700;transition:opacity 0.3s}
        .btn:hover{opacity:0.9}

        .profile-photo-area{display:flex;flex-direction:column;align-items:center;margin-bottom:20px;}
        #profile-photo-display{
            width:120px;height:120px;border-radius:50%;object-fit:cover;margin-bottom:15px;
            border:4px solid var(--accent);box-shadow:0 0 15px rgba(0,212,255,0.4);
        }
        #file-upload-label{
            cursor:pointer;padding:8px 15px;border-radius:8px;background:var(--glass);
            color:var(--accent);border:1px solid var(--accent);font-size:0.9rem;
            display: none; 
        }
        #file-input{display:none;}
        #profile-form.edit-mode #file-upload-label { display: block; }

        @media (max-width:640px){.wrap{flex-direction:column}.sidebar{width:100%;flex-direction:row;overflow-x:auto;padding:12px}.content{padding:14px}}
    </style>
</head>
<body>
    <div class="wrap">
        <aside class="sidebar">
            <div class="logo">
                <img id="ikon-user" src="profil2.png" alt="ikon">
                <div>
                    <div class="title">MyDashboard</div>
                    <small style="color:var(--muted)">Selamat datang</small>
                </div>
            </div>
            <div class="profile-card">
                <div class="p-info">
                    <h3 id="nama-user">--</h3>
                    <small id="email-user">--</small>
                </div>
            </div>
            <nav class="nav">
                <a href="beranda.html">Beranda <small>›</small></a>
                <a href="profil.html" class="active">Profil <small>›</small></a>
                <a href="tugas.html">Tugas <small>›</small></a>
                <a href="chat.html">Pesan <small>›</small></a>
                <a href="kuis.html">Menejemen Kuis<small>›</small></a>
            </nav>
            <div style="margin-top:auto;color:var(--muted);font-size:0.85rem">
                Versi alpha • &copy; 2025
            </div>
        </aside>

        <main class="content">
            <div class="top">
                <div style="font-size:1.25rem;font-weight:700">Profil Saya</div>
                <button id="btn-logout" class="btn" style="padding:6px 12px;">Keluar</button>
            </div>
            <div class="grid">
                <section class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h2>Informasi Akun</h2>
                        <button type="button" class="btn" id="btn-toggle-edit" style="padding:8px 12px; background:var(--accent-2); color:#e8eef6;">Edit Profil</button>
                    </div>
                    
                    <form id="profile-form">
                        <div class="profile-photo-area">
                            <img id="profile-photo-display" src="profil2.png" alt="Foto Profil">
                            <input type="file" id="file-input" accept="image/*">
                            <label for="file-input" id="file-upload-label">Ubah Foto</label>
                        </div>

                        <div class="form-group">
                            <label for="fullname">Nama Lengkap</label>
                            <input type="text" id="fullname" disabled placeholder="Masukkan Nama Lengkap Anda" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="text" id="email" disabled>
                        </div>
                        <div class="form-group">
                            <label for="phone">Nomor Telepon</label>
                            <input type="tel" id="phone" disabled placeholder="Contoh: 081234567890">
                        </div>
                        <div class="form-group">
                            <label for="birth">Tanggal Lahir</label>
                            <input type="date" id="birth" disabled>
                        </div>
                        <div class="form-group">
                            <label for="gender">Jenis Kelamin</label>
                            <select id="gender" disabled>
                                <option value="">Pilih</option>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="address">Alamat Lengkap</label>
                            <textarea id="address" rows="3" disabled placeholder="Masukkan alamat lengkap Anda"></textarea>
                        </div>
                        <button type="submit" class="btn" id="btn-update" style="display:none;">Simpan Perubahan</button>
                    </form>
                    <p id="status-message" style="margin-top:15px; color:var(--accent); font-weight:600;"></p>
                </section>
            </div>
        </main>
    </div>

<script>
    const userId = sessionStorage.getItem("currentUser");
    if (!userId) {
      alert("Silakan login terlebih dahulu.");
      window.location.href = "index.html";
    }

    const supabase = window.supabase.createClient(
        "https://hnsvxbohvjjfikmdjfpn.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhuc3Z4Ym9odmpqZmlrbWRqZnBuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0Nzk0NDMsImV4cCI6MjA2ODA1NTQ0M30.KzOeS0md4A6jeexgXxSdfuXuBbG5L1WtFginkztaPFw"
    );

    const elNamaUser = document.getElementById("nama-user");
    const elEmailUser = document.getElementById("email-user");
    const elIkonUser = document.getElementById("ikon-user");
    const elFullname = document.getElementById("fullname");
    const elEmailInput = document.getElementById("email");
    const elPhone = document.getElementById("phone");
    const elBirth = document.getElementById("birth");
    const elGender = document.getElementById("gender");
    const elAddress = document.getElementById("address");
    
    const elProfilePhotoDisplay = document.getElementById("profile-photo-display");
    const elFileInput = document.getElementById("file-input");
    const elStatusMessage = document.getElementById("status-message");
    const elProfileForm = document.getElementById("profile-form");
    const elBtnUpdate = document.getElementById("btn-update");
    const elBtnToggleEdit = document.getElementById("btn-toggle-edit");

    let currentPhotoUrl = 'profil2.png';
    let isEditMode = false;

    const editableInputs = [elFullname, elPhone, elBirth, elGender, elAddress];

    function toggleEditMode(enable) {
        isEditMode = enable;
        elProfileForm.classList.toggle('edit-mode', enable);

        editableInputs.forEach(input => {
            if (input.id !== 'email') { 
                input.disabled = !enable;
            }
        });

        elBtnUpdate.style.display = enable ? 'block' : 'none';
        elBtnToggleEdit.textContent = enable ? 'Batalkan Edit' : 'Edit Profil';
        elBtnToggleEdit.style.background = enable ? 'red' : 'var(--accent-2)';
        elStatusMessage.textContent = '';
        
        if (!enable) {
            loadProfile(); 
        }
    }

    async function loadProfile() {
      const { data, error } = await supabase
        .from("accounts")
        .select("fullname, email, photo, phone, birth, gender, address")
        .eq("id", userId) 
        .maybeSingle();

      if (error) { 
          console.error(error); 
          elStatusMessage.textContent = "Gagal memuat data profil.";
          return;
      }
      
      if (data) {
        elNamaUser.textContent = data.fullname || "Tanpa Nama";
        elEmailUser.textContent = data.email || "Tidak ada email";
        
        elFullname.value = data.fullname || "";
        elEmailInput.value = data.email || "";
        elPhone.value = data.phone || "";
        elBirth.value = data.birth || ""; 
        elGender.value = data.gender || "";
        elAddress.value = data.address || "";

        if (data.photo) {
          currentPhotoUrl = data.photo;
          elIkonUser.src = data.photo;
          elProfilePhotoDisplay.src = data.photo;
        } else {
          elProfilePhotoDisplay.src = 'profil2.png';
        }
      }
    }

    async function uploadPhoto(file) {
        const fileExt = file.name.split('.').pop();
        const fileName = `${userId}-${Date.now()}.${fileExt}`; 
        const filePath = `${userId}/${fileName}`; 

        const { error: uploadError } = await supabase.storage
            .from('avatars')
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
            });

        if (uploadError) {
            console.error("Gagal upload:", uploadError);
            return null;
        }

        const { data: publicUrlData } = supabase.storage
            .from('avatars')
            .getPublicUrl(filePath);

        return publicUrlData.publicUrl;
    }
    
    async function updateProfile(e) {
        e.preventDefault();
        elStatusMessage.textContent = "Sedang menyimpan...";
        
        const newFullname = elFullname.value.trim();
        const newPhone = elPhone.value.trim();
        const newBirth = elBirth.value;
        const newGender = elGender.value;
        const newAddress = elAddress.value.trim();
        
        let newPhotoUrl = currentPhotoUrl;
        let updateData = { 
            fullname: newFullname,
            phone: newPhone || null,
            birth: newBirth || null,
            gender: newGender || null,
            address: newAddress || null
        };
        
        const file = elFileInput.files[0];
        
        if (file) {
            elStatusMessage.textContent = "Mengunggah foto dan menyimpan...";
            newPhotoUrl = await uploadPhoto(file);
            if (!newPhotoUrl) {
                elStatusMessage.textContent = "Gagal mengunggah foto.";
                return;
            }
            updateData.photo = newPhotoUrl;
        }

        const { error } = await supabase
            .from("accounts")
            .update(updateData)
            .eq("id", userId);

        if (error) {
            console.error(error);
            elStatusMessage.style.color = 'red';
            elStatusMessage.textContent = "Gagal memperbarui profil: " + error.message;
        } else {
            elStatusMessage.style.color = 'var(--accent)';
            elStatusMessage.textContent = "Profil berhasil diperbarui! ✅";
            currentPhotoUrl = newPhotoUrl;
            
            toggleEditMode(false); 
            setTimeout(() => {elStatusMessage.textContent = '';}, 3000); 
        }
    }

    elBtnToggleEdit.addEventListener('click', () => {
        toggleEditMode(!isEditMode);
    });

    elFileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                elProfilePhotoDisplay.src = e.target.result;
            }
            reader.readAsDataURL(this.files[0]);
        }
    });

    document.getElementById('btn-logout').addEventListener('click', ()=>{
      sessionStorage.clear();
      alert('Anda telah logout.');
      window.location.href = 'index.html';
    });

    elProfileForm.addEventListener('submit', updateProfile);

    loadProfile();
</script>
</body>
</html>
